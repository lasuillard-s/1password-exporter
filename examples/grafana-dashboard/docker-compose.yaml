services:
  prometheus:
    image: prom/prometheus:latest
    extra_hosts:
      - host.docker.internal:host-gateway
    ports:
      - 9090:9090
    volumes:
      - prometheus-data:/prometheus
    configs:
      - source: prometheus.yaml
        target: /etc/prometheus/prometheus.yml
    command:
      - --config.file=/etc/prometheus/prometheus.yml

  grafana:
    image: grafana/grafana:latest
    ports:
      - 3000:3000
    volumes:
      - ./dashboard.json:/var/lib/grafana/dashboards/dashboard.json
    configs:
      - source: datasource.yaml
        target: /etc/grafana/provisioning/datasources/datasource.yaml
      - source: dashboards.yaml
        target: /etc/grafana/provisioning/dashboards/default.yaml
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin

configs:
  datasource.yaml:
    content: |
      apiVersion: 1
      datasources:
      - name: Prometheus
        type: prometheus
        url: http://prometheus:9090
        isDefault: true
        access: proxy
        editable: true

  dashboards.yaml:
    content: |
      apiVersion: 1
      providers:
        - name: "default"
          orgId: 1
          folder: ""
          type: file
          disableDeletion: false
          updateIntervalSeconds: 60
          options:
            path: /var/lib/grafana/dashboards

  prometheus.yaml:
    content: |
      global:
        scrape_interval: 30s
        scrape_timeout: 15s
        evaluation_interval: 15s
      alerting:
        alertmanagers:
        - static_configs:
          - targets: []
          scheme: http
          timeout: 10s
          api_version: v1
      scrape_configs:
      - job_name: onepassword
        honor_timestamps: true
        scrape_interval: 30s
        scrape_timeout: 15s
        metrics_path: /metrics
        scheme: http
        static_configs:
        - targets:
          - host.docker.internal:9999

volumes:
  prometheus-data:
